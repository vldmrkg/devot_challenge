!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("tldts-experimental"),require("@cliqz/adblocker"),require("@cliqz/adblocker-content")):"function"==typeof define&&define.amd?define(["exports","tldts-experimental","@cliqz/adblocker","@cliqz/adblocker-content"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).adblocker={},e.tldtsExperimental,e.adblocker,e.adblockerContent)}(this,(function(e,t,o,n){"use strict";function a(e){return new Promise((t=>{setTimeout(t,e)}))}function s(e){let t="";for(;null!==e&&(t=e.url(),0===t.length);)e=e.parentFrame();return t}function r(e){const t=s(e.frame()),n=e.url(),a=e.resourceType();return o.Request.fromRawDetails({_originalRequestDetails:e,requestId:`${a}-${n}-${t}`,sourceUrl:t,type:a,url:n})}class i{constructor(e,t){this.page=e,this.blocker=t,this.onFrameNavigated=e=>t.onFrameNavigated(e),this.onRequest=e=>t.onRequest(e)}async enable(){!0===this.blocker.config.loadCosmeticFilters&&(this.page.on("framenavigated",this.onFrameNavigated),this.page.once("domcontentloaded",(()=>{this.onFrameNavigated(this.page.mainFrame())}))),!0===this.blocker.config.loadNetworkFilters&&await this.page.route("**/*",this.onRequest)}async disable(){!0===this.blocker.config.loadNetworkFilters&&await this.page.unroute("**/*",this.onRequest),!0===this.blocker.config.loadCosmeticFilters&&this.page.off("framenavigated",this.onFrameNavigated)}}class c extends o.FiltersEngine{constructor(){super(...arguments),this.contexts=new WeakMap,this.onFrameNavigated=async e=>{try{await this.onFrame(e)}catch(e){}},this.onFrame=async e=>{const o=e.url();if("chrome-error://chromewebdata/"===o)return;this.removeBlockedFrames(e).catch((()=>{}));const s=t.parse(o),r=s.hostname||"",i=s.domain||"";{const{active:t,styles:n,scripts:a}=this.getCosmeticsFilters({domain:i,hostname:r,url:o,getBaseRules:!0,getInjectionRules:!0,getExtendedRules:!0,getRulesFromHostname:!0,getRulesFromDOM:!1});if(!1===t)return;Promise.all([this.injectScriptletsIntoFrame(e,a),this.injectStylesIntoFrame(e,n)]).catch((()=>{}))}const c=new n.DOMMonitor((t=>{if("features"===t.type){const{active:n,styles:a}=this.getCosmeticsFilters({domain:i,hostname:r,url:o,...t,getBaseRules:!1,getInjectionRules:!1,getExtendedRules:!1,getRulesFromHostname:!1,getRulesFromDOM:!0});if(!1===n)return;this.injectStylesIntoFrame(e,a).catch((()=>{}))}}));let l=0;for(;;){if(e.isDetached())break;try{const t=c.handleNewFeatures(await e.$$eval(":root",n.extractFeaturesFromDOM));if(l+=1,10===l)break;if(!1===t)break}catch(e){break}if(!1===this.config.enableMutationObserver)break;await a(500)}},this.onRequest=async e=>{const t=e.request(),o=r(t);!0===this.config.guessRequestTypeFromUrl&&"other"===o.type&&o.guessTypeOfRequest();const n=t.frame();if(o.isMainFrame()||"document"===o.type&&null!==n&&null===n.parentFrame())return void e.continue();const{redirect:a,match:s}=this.match(o);void 0!==a?a.contentType.endsWith(";base64")?e.fulfill({body:Buffer.from(a.body,"base64"),contentType:a.contentType.slice(0,-7)}):e.fulfill({body:a.body,contentType:a.contentType}):!0===s?e.abort("blockedbyclient"):e.continue()}}async enableBlockingInPage(e){let t=this.contexts.get(e);return void 0!==t||(t=new i(e,this),this.contexts.set(e,t),await t.enable()),t}async disableBlockingInPage(e){const t=this.contexts.get(e);if(void 0===t)throw new Error("Trying to disable blocking which was not enabled");this.contexts.delete(e),await t.disable()}isBlockingEnabled(e){return this.contexts.has(e)}async injectStylesIntoFrame(e,t){0!==t.length&&await e.addStyleTag({content:t})}async injectScriptletsIntoFrame(e,t){const o=[];if(0!==t.length)for(const a of t)o.push(e.addScriptTag({content:n.autoRemoveScript(a)}));await Promise.all(o)}async removeBlockedFrames(e){const t=[],n=s(e);for(const a of await e.$$eval("iframe[src],iframe[href]",(e=>e.map((({src:e,href:t})=>e||t))))){const{match:s}=this.match(o.Request.fromRawDetails({url:a,sourceUrl:n,type:"sub_frame"}));s&&t.push(e.$$eval(`iframe[src="${a}"],iframe[href="${a}"]`,(e=>{var t;for(const o of e)null===(t=null==o?void 0:o.parentNode)||void 0===t||t.removeChild(o)})).catch((()=>{})))}await Promise.all(t)}}e.BlockingContext=i,e.PlaywrightBlocker=c,e.fromPlaywrightDetails=r,Object.keys(o).forEach((function(t){"default"===t||Object.prototype.hasOwnProperty.call(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:function(){return o[t]}})}))}));
//# sourceMappingURL=adblocker.umd.min.js.map
